[supervisord]
nodaemon=true               ; Run in the foreground to keep the container alive
logfile=/var/log/supervisor/supervisord.log
pidfile=/var/run/supervisord.pid

[program:livekit]
command=/usr/local/bin/livekit-server --dev --udp-port 7882 --bind 0.0.0.0
directory=/app
priority=100                ; Start this first
startsecs=10                ; Wait 10s to assume it's stable
startretries=3              ; Stop retrying after 3 failures
stopwaitsecs=10             ; Graceful shutdown timeout
stdout_logfile=/var/log/livekit.log
stderr_logfile=/var/log/livekit.log
stdout_maxbytes=50MB        ; Rotate logs at 50MB
stderr_maxbytes=50MB
stdout_logfile_backups=3    ; Keep 3 backup files
stderr_logfile_backups=3
autorestart=true

[program:token-server]
; Use Gunicorn for production-grade WSGI server instead of Flask dev server
command=uv run gunicorn -w 2 -b 0.0.0.0:8080 token_server:app
directory=/app
priority=200                ; Start after livekit
startsecs=5                 ; Wait 5s
startretries=3              ; Stop retrying after 3 failures
stopwaitsecs=10             ; Graceful shutdown timeout
stdout_logfile=/var/log/token-server.log
stderr_logfile=/var/log/token-server.log
stdout_maxbytes=50MB        ; Rotate logs at 50MB
stderr_maxbytes=50MB
stdout_logfile_backups=3    ; Keep 3 backup files
stderr_logfile_backups=3
autorestart=true

[program:agent]
command=uv run python agent.py start
directory=/app
priority=200                ; Start after livekit
startsecs=30                ; Give agent 30s to load models
startretries=3              ; Stop retrying after 3 failures
stopwaitsecs=20             ; Allow time for proper session cleanup
stdout_logfile=/var/log/agent.log
stderr_logfile=/var/log/agent.log
stdout_maxbytes=50MB        ; Rotate logs at 50MB
stderr_maxbytes=50MB
stdout_logfile_backups=3    ; Keep 3 backup files
stderr_logfile_backups=3
autorestart=true

[program:startup-waiter]
; Script that blocks until agent is ready
priority=290
command=/bin/bash -c "while ! curl -sf http://localhost:8080/ready > /dev/null; do sleep 1; done"
autorestart=false
exitcodes=0
stdout_logfile=/var/log/startup-waiter.log
stderr_logfile=/var/log/startup-waiter.log
stdout_maxbytes=10MB
stderr_maxbytes=10MB
stdout_logfile_backups=2
stderr_logfile_backups=2

[program:react-app]
command=http-server -p 4173 -a 0.0.0.0 --silent
directory=/app/react-app/dist
priority=300                ; Start after startup-waiter completes
startsecs=5
startretries=3              ; Stop retrying after 3 failures
stopwaitsecs=10             ; Graceful shutdown timeout
stdout_logfile=/var/log/react-app.log
stderr_logfile=/var/log/react-app.log
stdout_maxbytes=50MB        ; Rotate logs at 50MB
stderr_maxbytes=50MB
stdout_logfile_backups=3    ; Keep 3 backup files
stderr_logfile_backups=3
autorestart=true